<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¹ã‚¿ãƒ¬ã‚¾ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»åŠ¹ç‡è¨ˆç®—æ©Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+2:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --white:#fff;--bg:#f5f6fa;--bg2:#eef0f7;
  --border:#e2e5f0;--border2:#d0d4e8;
  --accent:#3d6ef5;--accent-l:#eef1ff;
  --g:#0bbf97;--g-l:#e6faf6;
  --npc:#7c4dff;--npc-l:#f5eeff;
  --profit:#0aab6a;--profit-l:#e6f8f0;
  --loss:#e8354a;--loss-l:#fdeef0;
  --warn:#e08c00;--warn-l:#fff8e6;
  --focus:#0ea5e9;--focus-l:#e0f5ff;
  --normal:#64748b;--normal-l:#f1f5f9;
  --t1:#1a1e2e;--t2:#4a5270;--t3:#8a91b0;--t4:#c2c7db;
  --mono:'DM Mono',monospace;--sans:'M PLUS 2',sans-serif;
  --r:10px;--sh:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);--sh-lg:0 8px 24px rgba(0,0,0,.10)
}
html{font-size:14px}
body{font-family:var(--sans);background:var(--bg);color:var(--t1);min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
.app-body{flex:1;overflow:hidden}
.tab-page{display:none;height:100%}.tab-page.active{display:flex}

/* HEADER */
.app-header{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;height:56px;gap:16px;flex-shrink:0;box-shadow:var(--sh);z-index:50}
.logo{width:30px;height:30px;border-radius:7px;background:linear-gradient(135deg,var(--accent) 0%,#6b48ff 100%);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.app-title{font-size:14px;font-weight:800;letter-spacing:.02em}
.app-sub{font-size:10px;color:var(--t3);font-weight:500;letter-spacing:.04em}
.nav{display:flex;align-items:center;gap:2px;margin-left:20px}
.nav-btn{padding:5px 14px;border-radius:7px;border:none;background:transparent;color:var(--t2);font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap}
.nav-btn:hover{background:var(--bg);color:var(--t1)}
.nav-btn.active{background:var(--accent-l);color:var(--accent)}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;border:1px solid var(--border2);color:var(--t3);background:var(--bg2)}
.badge.ok{color:var(--profit);background:var(--profit-l);border-color:#a8e6cc}
.badge.err{color:var(--loss);background:var(--loss-l);border-color:#f4b8be}

/* LOADING / NOTIF */
.loading{position:fixed;inset:0;background:var(--white);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.notif{position:fixed;bottom:18px;right:18px;background:var(--t1);color:#fff;padding:9px 16px;border-radius:8px;font-size:13px;box-shadow:var(--sh-lg);transform:translateY(60px);opacity:0;transition:all .25s cubic-bezier(.34,1.56,.64,1);z-index:999}
.notif.show{transform:translateY(0);opacity:1}

/* TAG BADGES */
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;white-space:nowrap}
.tag-å®Œæˆå“{background:var(--accent-l);color:var(--accent)}
.tag-æœªå…¥åŠ›{background:#fee2e2;color:#b91c1c}
.tag-ä¸­é–“ç´ æ{background:var(--warn-l);color:var(--warn)}
.tag-ç´ æ{background:var(--bg2);color:var(--t2)}
.tag-NPCè³¼å…¥å¯{background:var(--npc-l);color:var(--npc)}
.tag-ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¡å–{background:var(--focus-l);color:var(--focus)}
.tag-é€šå¸¸æ¡å–{background:var(--normal-l);color:var(--normal)}
.tag-åˆ¶ä½œç‰©{background:var(--profit-l);color:var(--profit)}

/* CATEGORY BADGES */
.cat-badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700}
.cat-æ–™ç†{background:#fff5e6;color:#d47800}.cat-éŒ¬é‡‘{background:#e6faf6;color:#0b9e7d}
.cat-å·¥èŠ¸{background:#f5eeff;color:#7c4dff}.cat-æœ¨å·¥{background:#f5ede6;color:#8d5e2a}
.cat-é›é€ {background:#eef4f8;color:#4a7fa0}.cat-ç¹”ç‰©{background:#fff0f5;color:#d44087}

/* ===================== PAGE: ç´ æä¾¡æ ¼å…¥åŠ› ===================== */
#page-mat{flex-direction:row;overflow:hidden}
.mat-sidebar{width:220px;flex-shrink:0;border-right:1px solid var(--border);background:var(--white);display:flex;flex-direction:column;overflow:hidden}
.sidebar-head{padding:12px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--t3);letter-spacing:.07em;text-transform:uppercase}
.sidebar-nav{flex:1;overflow-y:auto;padding:8px}
.snav-item{display:flex;align-items:center;gap:7px;padding:8px 10px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:500;color:var(--t2);transition:all .12s;user-select:none}
.snav-item:hover{background:var(--bg);color:var(--t1)}
.snav-item.active{background:var(--accent-l);color:var(--accent);font-weight:700}
.snav-cnt{margin-left:auto;font-size:10px;background:var(--bg2);color:var(--t3);padding:1px 6px;border-radius:10px;font-family:var(--mono)}
.mat-main{flex:1;overflow-y:auto;padding:24px 28px;background:var(--bg)}
.page-title{font-size:16px;font-weight:800;margin-bottom:16px}

/* Material table */
.mat-tbl-wrap{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:12px}
.mat-tbl{width:100%;border-collapse:collapse}
.mat-tbl th{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;padding:8px 16px;text-align:left;background:var(--bg);border-bottom:1px solid var(--border)}
.mat-tbl td{padding:10px 16px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
.mat-tbl tr:last-child td{border-bottom:none}
.mat-tbl tr:hover td{background:#fafbff}
.mat-name{font-weight:600}
.mat-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
.col-r{text-align:right;white-space:nowrap}

/* Price input */
.price-wrap{display:flex;align-items:center;gap:6px;justify-content:flex-end;flex-wrap:wrap}
.npc-ref{font-size:10px;color:var(--npc);background:var(--npc-l);padding:2px 7px;border-radius:4px;font-family:var(--mono);white-space:nowrap;border:1px solid rgba(124,77,255,.2)}
.price-inp{width:120px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);font-family:var(--mono);font-size:13px;padding:6px 10px;text-align:right;outline:none;transition:border-color .15s,background .15s}
.price-inp:focus{border-color:var(--accent);background:var(--white);box-shadow:0 0 0 3px rgba(61,110,245,.1)}
.price-inp.filled{border-color:var(--g);background:var(--g-l)}
.unit{font-size:11px;color:var(--t3)}

/* ===================== PAGE: è¨ˆç®— ===================== */
#page-calc{flex-direction:row;overflow:hidden}
.list-col{width:300px;flex-shrink:0;border-right:1px solid var(--border);background:var(--white);display:flex;flex-direction:column;overflow:hidden}
.list-head{padding:14px 14px 10px;border-bottom:1px solid var(--border)}
.list-head h2{font-size:13px;font-weight:700;margin-bottom:10px}
.search-wrap{position:relative}
.search-wrap input{width:100%;padding:7px 10px 7px 30px;border:1px solid var(--border);border-radius:7px;background:var(--bg);color:var(--t1);font-family:var(--sans);font-size:12px;outline:none;transition:border-color .15s}
.search-wrap input:focus{border-color:var(--accent);background:var(--white)}
.search-wrap::before{content:'â–·';position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:12px;pointer-events:none}
.filter-bar{display:flex;flex-wrap:wrap;gap:4px;padding:8px 14px;border-bottom:1px solid var(--border);background:var(--bg)}
.fbtn{padding:3px 8px;border-radius:20px;border:1px solid var(--border);background:var(--white);color:var(--t2);font-family:var(--sans);font-size:11px;font-weight:600;cursor:pointer;transition:all .12s}
.fbtn:hover{border-color:var(--accent);color:var(--accent)}
.fbtn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.item-scroll{flex:1;overflow-y:auto}
.item-row{display:flex;align-items:center;padding:9px 14px;gap:8px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s}
.item-row:last-child{border-bottom:none}
.item-row:hover{background:#fafbff}
.item-row.sel{background:var(--accent-l);border-left:3px solid var(--accent);padding-left:11px}
.row-name{flex:1;font-size:13px;font-weight:500;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.row-sub{font-size:10px;color:var(--t3);margin-top:1px}
.chip{font-family:var(--mono);font-size:11px;padding:2px 7px;border-radius:5px;white-space:nowrap;flex-shrink:0}
.chip-p{background:var(--profit-l);color:var(--profit)}.chip-l{background:var(--loss-l);color:var(--loss)}.chip-z{background:var(--bg2);color:var(--t3)}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* Detail */
.detail-col{flex:1;overflow-y:auto;background:var(--bg);padding:28px}
.empty-state{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--t3);gap:10px}
.empty-state .icon{font-size:36px}
.det-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:20px}
.det-icon{width:48px;height:48px;border-radius:10px;background:var(--accent-l);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;border:1px solid var(--border)}
.det-name{font-size:19px;font-weight:800;margin-bottom:6px}
.det-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;box-shadow:var(--sh)}
.stat-card.hi{border-color:var(--accent);background:var(--accent-l)}
.stat-lbl{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;margin-bottom:7px}
.stat-val{font-family:var(--mono);font-size:20px;font-weight:500}
.stat-card.hi .stat-val{color:var(--accent)}
.v-profit{color:var(--profit)}.v-loss{color:var(--loss)}.v-accent{color:var(--accent)}.v-warn{color:var(--warn)}
.sec-title{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;margin-top:22px;display:flex;align-items:center;gap:8px}
.sec-title::after{content:'';flex:1;height:1px;background:var(--border)}
.warn-box{font-size:12px;color:var(--warn);background:var(--warn-l);padding:8px 12px;border-radius:7px;margin-bottom:16px}

/* Breakdown table */
.bd-tbl{width:100%;border-collapse:collapse;background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.bd-tbl th{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;padding:8px 14px;text-align:left;background:var(--bg);border-bottom:1px solid var(--border)}
.bd-tbl th:last-child{text-align:right}
.bd-tbl td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:top}
.bd-tbl tr:last-child td{border-bottom:none}
.bd-tbl tr:hover td{background:#fafbff}
.bd-tbl td:last-child{text-align:right;font-family:var(--mono);font-size:12px;color:var(--t2)}
.tr-main{font-weight:600;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.tr-sub{font-size:11px;color:var(--t3);padding-left:12px;line-height:1.9}
.tr-sub::before{content:'â”” ';color:var(--t4)}
/* cost source badge */
.src-auto{background:var(--g-l);color:var(--g);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px}
.src-mkt{background:var(--accent-l);color:var(--accent);font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px}
.mat-clickable{cursor:pointer;text-decoration:underline dotted var(--t3);transition:color .1s}
.mat-clickable:hover{color:var(--accent)}
@keyframes jump-flash{0%,100%{background:transparent}40%{background:#fff3cd}}
.jump-highlight{animation:jump-flash 1.2s ease}
/* é€šè²¨ãƒãƒƒã‚¸ */
.cur-runo{background:#eef1ff;color:#3d6ef5;font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px;font-family:var(--mono);white-space:nowrap;display:inline-block}
.cur-bind{background:var(--npc-l);color:var(--npc);font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px;font-family:var(--mono);white-space:nowrap;display:inline-block}
.cur-focus{background:var(--focus-l);color:var(--focus);font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px;font-family:var(--mono);white-space:nowrap;display:inline-block}
.unk{background:var(--loss-l);color:var(--loss);font-size:11px;font-family:var(--mono);padding:2px 8px;border-radius:5px;display:inline-block}
.info-box{background:#f0f7ff;border:1px solid #b8d9f5;color:#2563a6;border-radius:7px;padding:10px 14px;font-size:12px;margin-bottom:12px}
.mkt-toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
.mkt-toggle input[type=checkbox]{width:15px;height:15px;cursor:pointer;accent-color:var(--accent)}
.mkt-toggle-label{font-size:12px;font-weight:600;color:var(--t2)}
.mkt-toggle:has(input:checked) .mkt-toggle-label{color:var(--accent)}

/* ===================== PAGE: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===================== */
#page-rank{flex-direction:column;overflow-y:auto;padding:28px;background:var(--bg)}
.rank-wrap{max-width:800px;width:100%;margin:0 auto}
.rank-title{font-size:18px;font-weight:800;margin-bottom:5px}
.rank-sub{font-size:12px;color:var(--t3);margin-bottom:22px}
.rank-tbl{width:100%;border-collapse:collapse;background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
.rank-tbl th{font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.06em;text-transform:uppercase;padding:10px 16px;text-align:left;background:var(--bg);border-bottom:1px solid var(--border)}
.rank-tbl th:nth-child(n+4){text-align:right}
.rank-tbl td{padding:11px 16px;font-size:13px;border-bottom:1px solid var(--border)}
.rank-tbl tr:last-child td{border-bottom:none}
.rank-tbl tr:hover td{background:#fafbff}
.rank-tbl td:nth-child(n+4){text-align:right;font-family:var(--mono)}
.rank-no{font-size:13px;font-weight:700;color:var(--t3);font-family:var(--mono)}
.mastery-btn{padding:4px 12px;border-radius:20px;border:none;cursor:pointer;font-size:12px;font-weight:700;transition:all .15s}
.mastery-btn.mastery-on{background:var(--profit-l);color:var(--profit);border:1.5px solid var(--profit)}
.mastery-btn.mastery-off{background:var(--bg2);color:var(--t3);border:1.5px solid var(--border)}
.rank-name-link{cursor:pointer;color:inherit;text-decoration:underline dotted var(--t3)}
.rank-name-link:hover{color:var(--accent)}


/* â”€â”€ VISION MODAL â”€â”€ */
.vision-modal{position:fixed;inset:0;z-index:900;display:flex;align-items:center;justify-content:center;background:rgba(10,12,30,.72);backdrop-filter:blur(4px)}
.vision-modal.hidden{display:none}
.vision-box{background:var(--white);border-radius:14px;box-shadow:var(--sh-lg);width:min(96vw,720px);max-height:92vh;display:flex;flex-direction:column;overflow:hidden}
.vision-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.vision-head h3{font-size:14px;font-weight:700}
.vision-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--t3);padding:2px 6px;border-radius:5px}
.vision-close:hover{background:var(--bg);color:var(--t1)}
.vision-body{flex:1;overflow-y:auto;padding:18px 20px;display:flex;flex-direction:column;gap:14px}
.vision-drop{border:2px dashed var(--border2);border-radius:10px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .15s;background:var(--bg)}
.vision-drop:hover,.vision-drop.dragover{border-color:var(--accent);background:var(--accent-l)}
.vision-drop p{font-size:13px;color:var(--t3);margin-top:6px}
.vision-preview{max-width:100%;border-radius:8px;border:1px solid var(--border);display:block}
.vision-thinking{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--t2);padding:12px;background:var(--bg);border-radius:8px}
.vision-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:vdot 1.2s ease-in-out infinite}
.vision-dot:nth-child(2){animation-delay:.2s}
.vision-dot:nth-child(3){animation-delay:.4s}
@keyframes vdot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.vision-result{background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.vision-result-head{padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--t2);display:flex;align-items:center;justify-content:space-between}
.vision-row{display:flex;align-items:center;gap:10px;padding:7px 14px;border-bottom:1px solid var(--border);font-size:12px}
.vision-row:last-child{border-bottom:none}
.vision-row.matched{background:#f0fdf8}
.vision-row.unmatched{opacity:.5}
.vision-item-name{flex:1;font-weight:600}
.vision-price{font-family:var(--mono);color:var(--accent);font-weight:700;min-width:80px;text-align:right}
.vision-tag-ok{font-size:10px;background:var(--profit-l);color:var(--profit);border-radius:4px;padding:1px 6px;font-weight:600;flex-shrink:0}
.vision-tag-ng{font-size:10px;background:var(--bg2);color:var(--t3);border-radius:4px;padding:1px 6px;flex-shrink:0}
.vision-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div style="font-size:13px;color:var(--t3)">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="app" style="opacity:0;transition:opacity .3s">
  <header class="app-header">
    
    <div>
      <div class="app-title">ã‚¹ã‚¿ãƒ¬ã‚¾ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»åŠ¹ç‡è¨ˆç®—æ©Ÿ</div>
      <div class="app-sub">BLUE PROTOCOL: STAR RESONANCE</div>
    </div>
    <nav class="nav">
      <button class="nav-btn active" onclick="showPage('mat',this)">ä¾¡æ ¼å…¥åŠ›</button>
      <button class="nav-btn" onclick="showPage('calc',this)">ä½œæˆç‰© è²»ç”¨è¨ˆç®—</button>
      <button class="nav-btn" onclick="showPage('rank',this)">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </nav>
    <div class="header-right" style="display:flex;align-items:center;gap:8px">
      <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px" onclick="openVision()">AI ä¾¡æ ¼èª­ã¿å–ã‚Š</button>
      <button id="skill-btn" onclick="toggleSkill()" class="mastery-btn mastery-on" title="ãƒã‚¹ã‚¿ãƒªãƒ¼ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã®ON/OFF">ãƒã‚¹ã‚¿ãƒªãƒ¼ ON</button>
      <span class="badge" id="data-badge">èª­è¾¼ä¸­</span>
    </div>
  </header>

  <div class="app-body">

    <!-- ç´ æä¾¡æ ¼å…¥åŠ› -->
    <div id="page-mat" class="tab-page active">
      <aside class="mat-sidebar">
        <div class="sidebar-head">çµã‚Šè¾¼ã¿</div>
        <div class="sidebar-nav" id="mat-nav"></div>
      </aside>
      <main class="mat-main">
        <div class="page-title" id="mat-title">ã™ã¹ã¦ã®ç´ æ</div>
        <div id="mat-body"></div>
      </main>
    </div>

    <!-- è¨ˆç®— -->
    <div id="page-calc" class="tab-page">
      <div class="list-col">
        <div class="list-head">
          <h2>ä½œæˆç‰©ä¸€è¦§</h2>
          <div class="search-wrap">
            <input type="text" placeholder="åå‰ã§æ¤œç´¢..." oninput="onSearch(this.value)">
          </div>
        </div>
        <div class="filter-bar" id="cat-bar"></div>
        <div class="item-scroll" id="item-list"></div>
      </div>
      <div class="detail-col" id="detail">
        <div class="empty-state"><p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div id="page-rank" class="tab-page">
      <div class="rank-wrap">
        <div class="rank-title">åˆ©ç›Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
        <div class="rank-sub">è²©å£²ä¾¡æ ¼ã¨å…¨ç´ æä¾¡æ ¼ãŒå…¥åŠ›æ¸ˆã¿ã®ä½œæˆç‰©ï¼ˆå®Œæˆå“ãƒ»ä¸­é–“ç´ æï¼‰ãŒå¯¾è±¡</div>
        <div id="rank-body"></div>
      </div>
    </div>

  </div>
</div>


<!-- Vision AI ä¾¡æ ¼èª­ã¿å–ã‚Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="vision-modal hidden" id="vision-modal">
  <div class="vision-box">
    <div class="vision-head">
      <h3>AI å–å¼•æ‰€ä¾¡æ ¼ èª­ã¿å–ã‚Š</h3>
      <button class="vision-close" onclick="closeVision()">Ã—</button>
    </div>
    <div class="vision-body">

      <!-- ç”»åƒãƒ‰ãƒ­ãƒƒãƒ— / é¸æŠ -->
      <div id="vision-upload-area">
        <div class="vision-drop" id="vision-drop"
          onclick="document.getElementById('vision-file-input').click()"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleVisionDrop(event)">
          <div style="font-size:28px">ğŸ–¼ï¸</div>
          <div style="font-size:13px;font-weight:700;color:var(--t1);margin-top:8px">å–å¼•æ‰€ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
          <p>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ / Ctrl+V ã§è²¼ã‚Šä»˜ã‘</p>
        </div>
        <input type="file" id="vision-file-input" accept="image/*" style="display:none" onchange="loadVisionFile(this)">
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="vision-preview-wrap" style="display:none">
        <img id="vision-preview" class="vision-preview">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn btn-adm" onclick="runVision()">ã“ã®ç”»åƒã‚’è§£æ</button>
          <button class="btn btn-ghost" onclick="resetVision()">ç”»åƒã‚’å¤‰æ›´</button>
        </div>
      </div>

      <!-- å‡¦ç†ä¸­ -->
      <div id="vision-thinking" class="vision-thinking" style="display:none">
        <div class="vision-dot"></div><div class="vision-dot"></div><div class="vision-dot"></div>
        <span id="vision-thinking-text">AIãŒç”»åƒã‚’è§£æä¸­...</span>
      </div>

      <!-- çµæœ -->
      <div id="vision-result-wrap" style="display:none">
        <div class="vision-result">
          <div class="vision-result-head">
            <span id="vision-result-summary"></span>
            <label style="font-size:11px;display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:400">
              <input type="checkbox" id="vision-all-check" onchange="toggleAllVisionChecks(this.checked)"> ã™ã¹ã¦é¸æŠ
            </label>
          </div>
          <div id="vision-rows"></div>
        </div>
        <div class="vision-actions" style="margin-top:10px">
          <button class="btn btn-adm" id="vision-apply-btn" onclick="applyVisionResults()">ãƒã‚§ãƒƒã‚¯ã—ãŸä¾¡æ ¼ã‚’é©ç”¨</button>
          <button class="btn btn-ghost" onclick="resetVision()">æ’®ã‚Šç›´ã™</button>
          <span id="vision-apply-note" style="font-size:11px;color:var(--t3)"></span>
        </div>
      </div>

    </div>
  </div>
</div>
<div class="notif" id="notif"></div>

<script>


/* ===================== VISION AI ===================== */
let visionImageB64 = null;
let visionResults  = [];

function openVision(){
  document.getElementById('vision-modal').classList.remove('hidden');
  window.addEventListener('paste', handleVisionPaste);
}
function closeVision(){
  document.getElementById('vision-modal').classList.add('hidden');
  window.removeEventListener('paste', handleVisionPaste);
}
function resetVision(){
  visionImageB64=null; visionResults=[];
  document.getElementById('vision-upload-area').style.display='';
  document.getElementById('vision-preview-wrap').style.display='none';
  document.getElementById('vision-thinking').style.display='none';
  document.getElementById('vision-result-wrap').style.display='none';
}

function handleVisionPaste(e){
  const item=[...e.clipboardData.items].find(i=>i.type.startsWith('image'));
  if(!item) return;
  readImageFile(item.getAsFile());
}
function handleVisionDrop(e){
  e.preventDefault();
  document.getElementById('vision-drop').classList.remove('dragover');
  const file=e.dataTransfer.files[0];
  if(file&&file.type.startsWith('image')) readImageFile(file);
}
function loadVisionFile(input){
  if(input.files[0]) readImageFile(input.files[0]);
}

function readImageFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const dataUrl=e.target.result;
    visionImageB64=dataUrl.split(',')[1];
    const img=document.getElementById('vision-preview');
    img.src=dataUrl;
    document.getElementById('vision-upload-area').style.display='none';
    document.getElementById('vision-preview-wrap').style.display='';
    document.getElementById('vision-result-wrap').style.display='none';
  };
  reader.readAsDataURL(file);
}

async function runVision(){
  if(!visionImageB64) return;
  document.getElementById('vision-preview-wrap').querySelector('div').style.display='none';
  document.getElementById('vision-thinking').style.display='flex';
  document.getElementById('vision-result-wrap').style.display='none';

  // ç™»éŒ²æ¸ˆã¿ç´ æåãƒªã‚¹ãƒˆã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹ï¼ˆç…§åˆç²¾åº¦UPï¼‰
  const matNames = D.materials.map(m=>m.name).join('ã€');

  const prompt = `ã‚ãªãŸã¯ã‚²ãƒ¼ãƒ ã€ŒBlue Protocol: Star Resonanceã€ã®å–å¼•æ‰€ç”»é¢ã‚’èª­ã¿å–ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã“ã®ç”»åƒã¯å–å¼•æ‰€ã®è³¼å…¥ç”»é¢ã§ã™ã€‚ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦èª­ã¿å–ã‚Šã€å„ã‚¢ã‚¤ãƒ†ãƒ ã®ã€Œåå‰ã€ã¨ã€Œæœ€ä½ä¾¡æ ¼ï¼ˆæ•°å­—ï¼‰ã€ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ç™»éŒ²æ¸ˆã¿ç´ æåãƒªã‚¹ãƒˆï¼ˆç…§åˆç”¨ï¼‰:
${matNames}

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚å‰ç½®ããƒ»èª¬æ˜ã¯ä¸è¦ã§ã™:
[
  {"name": "ã‚¢ã‚¤ãƒ†ãƒ å", "price": æ•°å­—},
  ...
]

æ³¨æ„:
- ã€Œæœ€ä½ã€ã®å³ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ•°å­—ãŒä¾¡æ ¼ã§ã™
- ä¾¡æ ¼ã¯ã‚«ãƒ³ãƒãªã—ã®æ•´æ•°ã§
- ç™»éŒ²æ¸ˆã¿ç´ æåãƒªã‚¹ãƒˆã«ã‚ã‚‹åå‰ã¨ä¸€è‡´ãƒ»è¿‘ä¼¼ã™ã‚‹ã‚‚ã®ã¯ã€ãƒªã‚¹ãƒˆã®è¡¨è¨˜ã«åˆã‚ã›ã¦ãã ã•ã„
- ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã™ã¹ã¦åˆ—æŒ™ã—ã¦ãã ã•ã„`;

  try{
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-opus-4-5-20251101',
        max_tokens:1000,
        messages:[{
          role:'user',
          content:[
            {type:'image',source:{type:'base64',media_type:'image/png',data:visionImageB64}},
            {type:'text',text:prompt}
          ]
        }]
      })
    });
    const data=await res.json();
    const text=data.content.map(c=>c.text||'').join('');
    const clean=text.replace(/```json|```/g,'').trim();
    const parsed=JSON.parse(clean);
    processVisionResults(parsed);
  }catch(e){
    document.getElementById('vision-thinking').style.display='none';
    document.getElementById('vision-preview-wrap').querySelector('div').style.display='';
    notif('ã‚¨ãƒ©ãƒ¼: '+e.message);
  }
}

function matchMaterialByName(name){
  // å®Œå…¨ä¸€è‡´
  let m=D.materials.find(x=>x.name===name);
  // éƒ¨åˆ†ä¸€è‡´
  if(!m) m=D.materials.find(x=>x.name.includes(name)||name.includes(x.name));
  // ã‚ã„ã¾ã„ï¼ˆ60%ä»¥ä¸Šå…±é€šæ–‡å­—ï¼‰
  if(!m) m=D.materials.find(x=>{
    const a=x.name,b=name;
    if(Math.abs(a.length-b.length)>3) return false;
    const common=[...a].filter(c=>b.includes(c)).length;
    return common>=Math.min(a.length,b.length)*0.6;
  });
  return m||null;
}

function processVisionResults(parsed){
  document.getElementById('vision-thinking').style.display='none';
  document.getElementById('vision-preview-wrap').querySelector('div').style.display='';

  visionResults=parsed.map(item=>{
    const mat=matchMaterialByName(item.name);
    return {rawName:item.name, price:item.price, mat, checked:!!mat};
  });

  renderVisionResults();
  document.getElementById('vision-result-wrap').style.display='';
}

function renderVisionResults(){
  const matched=visionResults.filter(r=>r.mat).length;
  document.getElementById('vision-result-summary').textContent=
    `${matched}ä»¶ãƒãƒƒãƒ / ${visionResults.length}ä»¶æ¤œå‡º`;
  document.getElementById('vision-apply-btn').disabled=matched===0;
  document.getElementById('vision-all-check').checked=true;

  document.getElementById('vision-rows').innerHTML=visionResults.map((r,i)=>`
    <div class="vision-row ${r.mat?'matched':'unmatched'}">
      <input type="checkbox" id="vcr-${i}" ${r.checked&&r.mat?'checked':''} ${r.mat?'':'disabled'}>
      <label for="vcr-${i}" class="vision-item-name">
        ${r.mat?r.mat.name:r.rawName}
        ${r.mat&&r.mat.name!==r.rawName?`<span style="font-size:10px;color:var(--t3)">(AI: ${r.rawName})</span>`:''}
      </label>
      <span class="vision-price">${r.price.toLocaleString()} ãƒ«ãƒ¼ãƒ</span>
      ${r.mat?'<span class="vision-tag-ok">ãƒãƒƒãƒ</span>':'<span class="vision-tag-ng">æœªç…§åˆ</span>'}
    </div>
  `).join('');
}

function toggleAllVisionChecks(checked){
  visionResults.forEach((r,i)=>{
    if(!r.mat) return;
    const el=document.getElementById('vcr-'+i);
    if(el) el.checked=checked;
  });
}

function applyVisionResults(){
  let applied=0;
  visionResults.forEach((r,i)=>{
    if(!r.mat) return;
    const el=document.getElementById('vcr-'+i);
    if(!el||!el.checked) return;
    U[r.mat.id]=r.price;
    applied++;
  });
  saveUser(); refreshChips(); refreshMatNavCounts(); renderMatBody();
  closeVision();
  notif(`${applied}ä»¶ã®ä¾¡æ ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
}

/* ===================== STATE ===================== */
const STORAGE_KEY  = 'starreso_user_v3';
const STORAGE_MODE = 'starreso_mode_v3'; // ä¸­é–“ç´ æã®å–å¼•æ‰€è³¼å…¥ãƒ•ãƒ©ã‚°
const STORAGE_DATA = 'starreso_data_v3'; // ç®¡ç†è€…ãŒä¿å­˜ã—ãŸãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
const STORAGE_UI   = 'starreso_ui_v3';   // UIçŠ¶æ…‹ï¼ˆãƒã‚¹ã‚¿ãƒªãƒ¼ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ç­‰ï¼‰
let D  = { materials:[], recipes:[] }; // master data
let U  = loadUser();  // user prices: { matId/recipeId: price }
let UM = loadMode();  // user mode:  { recipeId: true=å–å¼•æ‰€è³¼å…¥, false/undefined=è‡ªå‹•è¨ˆç®— }

function loadUser(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{}; }catch{ return{}; } }
function saveUser(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(U)); }
function loadMode(){ try{ return JSON.parse(localStorage.getItem(STORAGE_MODE))||{}; }catch{ return{}; } }
function saveMode(){ localStorage.setItem(STORAGE_MODE, JSON.stringify(UM)); }
function loadUI(){   try{ return JSON.parse(localStorage.getItem(STORAGE_UI))||{}; }catch{ return{}; } }
function saveUI(){
  localStorage.setItem(STORAGE_UI, JSON.stringify({
    masteryMode, matFilter, selId, catF, unkF,
    activePage: document.querySelector('.tab-page.active')?.id || 'page-mat'
  }));
}
function loadStoredData(){
  try{
    const raw=localStorage.getItem(STORAGE_DATA);
    if(raw){ const d=JSON.parse(raw); if(d.materials&&d.recipes) return d; }
  }catch(e){}
  return null;
}

function setIntMode(id, useMarket){
  if(useMarket) UM[id]=true; else delete UM[id];
  saveMode();
  renderMatBody();
  refreshChips();
}

function setAllIntMode(useMarket){
  for(const r of D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ')){
    if(useMarket) UM[r.id]=true; else delete UM[r.id];
  }
  saveMode();
  renderMatBody();
  refreshChips();
}

/* ===================== LOAD ===================== */
/* ---- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«file://ã§ã‚‚å‹•ä½œï¼‰ ---- */
const INLINE_DATA = {"materials":[{"id":"m17715500825150.027191333549412833","name":"ã‚¢ã‚ºãƒ¼ãƒˆé‰±çŸ³","tag1":"ç´ æ","tag2":[],"npcPrice":null,"npcShops":[]},{"id":"m17715501701520.10791606628704498","name":"æœ¨ç‚­","tag1":"ç´ æ","tag2":["NPCè³¼å…¥å¯"],"npcPrice":660,"npcShops":["æœ¨å·¥ç´ æäº¤æ›"]},{"id":"m17715502591750.8569311540706177","name":"ãƒ«ãƒŠãƒ¼é‰±çŸ³","tag1":"ç´ æ","tag2":[],"npcPrice":null,"npcShops":[]},{"id":"m17715503046560.4270561090701753","name":"ãƒãƒ«ãƒ¼é‰±çŸ³","tag1":"ç´ æ","tag2":[],"npcPrice":null,"npcShops":[]}],"recipes":[{"id":"r1771550082515","name":"è¼å…‰çŸ³","category":"é›é€ ","tag1":"å®Œæˆå“","tag2":[],"qtyPerCraft":1,"focus":10,"skill":15,"note":"","materials":[{"name":"ã‚¢ã‚ºãƒ¼ãƒˆé‰±çŸ³","qty":8,"tag1":"ç´ æ"},{"name":"é€Ÿç‡ƒæ€§ç‚­ç²‰","qty":1,"tag1":"ä¸­é–“ç´ æ"}]},{"id":"r17715500825150.5436580541549987","name":"é€Ÿç‡ƒæ€§ç‚­ç²‰","category":"æœ¨å·¥","tag1":"ä¸­é–“ç´ æ","tag2":[],"qtyPerCraft":20,"focus":20,"skill":0,"note":"","materials":[{"name":"æœ¨ç‚­","qty":1,"tag1":"ç´ æ"}]},{"id":"r1771550259175","name":"ç²¾ç·´çŸ³","category":"é›é€ ","tag1":"å®Œæˆå“","tag2":[],"qtyPerCraft":1,"focus":10,"skill":15,"note":"","materials":[{"name":"ãƒ«ãƒŠãƒ¼é‰±çŸ³","qty":8,"tag1":"ç´ æ"},{"name":"é€Ÿç‡ƒæ€§ç‚­ç²‰","qty":1,"tag1":"ä¸­é–“ç´ æ"}]},{"id":"r1771550304656","name":"è¬ã®é‡‘å±","category":"é›é€ ","tag1":"å®Œæˆå“","tag2":[],"qtyPerCraft":1,"focus":10,"skill":15,"note":"","materials":[{"name":"ãƒãƒ«ãƒ¼é‰±çŸ³","qty":8,"tag1":"ç´ æ"},{"name":"é€Ÿç‡ƒæ€§ç‚­ç²‰","qty":1,"tag1":"ä¸­é–“ç´ æ"}]}]};

async function init(){
  const badge = document.getElementById('data-badge');

  // 1st: ç®¡ç†è€…ãŒä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆlocalStorageï¼‰
  const stored = loadStoredData();
  if(stored){
    D = stored;
    badge.textContent='ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆ'; badge.className='badge ok';
  } else {
    // 2nd: data.json
    try{
      const res = await fetch('data.json?'+Date.now());
      if(!res.ok) throw new Error(res.status);
      D = await res.json();
      badge.textContent='ãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰'; badge.className='badge ok';
    }catch(e){
      // 3rd: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿
      D = JSON.parse(JSON.stringify(INLINE_DATA));
      badge.textContent='ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ä¸­'; badge.className='badge ok';
    }
  }

  // NPCä¾¡æ ¼ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¥åŠ›ï¼ˆæœªå…¥åŠ›ã®ã‚‚ã®ã®ã¿ï¼‰
  for(const m of D.materials){
    if(m.npcPrice != null && U[m.id] == null) U[m.id] = m.npcPrice;
  }
  saveUser();
  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.opacity='1';

  // â”€â”€ UIçŠ¶æ…‹ã‚’å¾©å…ƒ â”€â”€
  const ui = loadUI();
  if(ui.masteryMode === false){
    masteryMode = false;
    const btn = document.getElementById('skill-btn');
    btn.textContent = 'ãƒã‚¹ã‚¿ãƒªãƒ¼ OFF';
    btn.className   = 'mastery-btn mastery-off';
  }
  if(ui.matFilter) matFilter = ui.matFilter;
  if(ui.catF)      catF      = ui.catF;
  if(ui.unkF)      unkF      = ui.unkF;
  if(ui.selId)     selId     = ui.selId;

  renderMatPage();
  renderCalcList();

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒšãƒ¼ã‚¸ã‚’å¾©å…ƒ
  if(ui.activePage && ui.activePage !== 'page-mat'){
    const pageId = ui.activePage.replace('page-','');
    const btn = document.querySelector(`.nav-btn[onclick*="'${pageId}'"]`);
    if(btn) showPage(pageId, btn);
  }
}

/* ===================== HELPERS ===================== */
const fmt  = n => Math.round(n).toLocaleString('ja-JP');
const fmtQ = n => n%1===0 ? String(n) : n.toFixed(2).replace(/\.?0+$/,'');
const catEmoji = c => c||'';
const catColor = c => ({æ–™ç†:'#d47800',éŒ¬é‡‘:'#0b9e7d',å·¥èŠ¸:'#7c4dff',æœ¨å·¥:'#8d5e2a',é›é€ :'#4a7fa0',ç¹”ç‰©:'#d44087'}[c]||'#8a91b0');

function getMat(name){ return D.materials.find(m=>m.name===name); }
function getRecipe(name){ return D.recipes.find(r=>r.name===name); }

// ã‚¹ã‚­ãƒ«ãƒœãƒ¼ãƒŠã‚¹ON/OFF
let masteryMode = true;
function toggleSkill(){
  masteryMode = !masteryMode;
  const btn = document.getElementById('skill-btn');
  btn.textContent = masteryMode ? 'ãƒã‚¹ã‚¿ãƒªãƒ¼ ON' : 'ãƒã‚¹ã‚¿ãƒªãƒ¼ OFF';
  btn.className = masteryMode ? 'mastery-btn mastery-on' : 'mastery-btn mastery-off';
  refreshChips();
  if(document.getElementById('page-rank').classList.contains('active')) renderRanking();
  saveUI();
}

// effective user price for a material. Returns the stored value (including 0), or null if unset.
function userMatPrice(mat){
  const v = U[mat.id];
  return (v !== undefined && v !== null) ? v : null;
}

// ã‚¹ã‚­ãƒ«æœŸå¾…å€¤å€ç‡: é€šå¸¸qtyPerCraftå€‹ã€skill%ç¢ºç‡ã§ã‚‚ã†1å€‹è¿½åŠ 
// ä¾‹) qty=3, skill=30% â†’ æœŸå¾…å€¤ 3 + 3Ã—0.3 = 3.9å€‹ â†’ å€ç‡=3.9/3=1.3
function skillMultiplier(recipe){
  if(!masteryMode || !recipe.skill) return 1;
  const p = recipe.skill / 100;
  return 1 + p; // æ¯å›ã‚¯ãƒ©ãƒ•ãƒˆã”ã¨ã«pç¢ºç‡ã§+1å€‹ãªã®ã§ (qty + qty*p)/qty = 1+p
}

/*
 * ===================== è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ =====================
 *
 * é€šè²¨åŒºåˆ¥:
 *   runo     = ãƒ«ãƒ¼ãƒ     (å–å¼•æ‰€ãƒ»å¸‚å ´ä¾¡æ ¼)
 *   bindRuno = ãƒã‚¤ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ (NPCè³¼å…¥ä¾¡æ ¼)
 *
 * ãƒ•ã‚©ãƒ¼ã‚«ã‚¹:
 *   è‡ªå‹•è¨ˆç®—çµŒè·¯ã‚’é€šã‚‹å ´åˆã®ã¿æ¶ˆè²»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç©ã¿ä¸Šã’ã‚‹
 *   å–å¼•æ‰€ä¾¡æ ¼ã‚’ä½¿ã£ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»ãªã—
 *
 * calcRecipeCost ã®æˆ»ã‚Šå€¤ (1ã‚¯ãƒ©ãƒ•ãƒˆåˆ†):
 *   runo, bindRuno, focus, hasUnk, breakdown
 *
 * breakdown ã®å„è¦ç´ :
 *   { name, qty,
 *     runo, bindRuno, focusUsed,   â† ã“ã®è¡Œã®è² æ‹…åˆ†
 *     src: 'auto'|'market'|'npc'|'raw'|'unknown',
 *     isRecipe, npcPrice, tag2,
 *     autoRunoPer, autoBindPer, autoFocusPer,  â† è‡ªå‹•è¨ˆç®—æ™‚ã®å˜ä¾¡
 *     mktPrice,                                â† å–å¼•æ‰€ä¾¡æ ¼
 *     subBreakdown, subQtyPerCraft }
 */
function calcRecipeCost(recipe, visited=new Set()){
  if(visited.has(recipe.id)) return {runo:null,bindRuno:0,focus:0,hasUnk:true,breakdown:[]};
  visited.add(recipe.id);

  let totalRuno=0, totalBind=0, totalFocus=0, hasUnk=false;
  const breakdown=[];

  for(const m of recipe.materials){
    const subR = getRecipe(m.name);
    const subM = getMat(m.name);

    if(subR){
      // â”€â”€ ä¸­é–“ç´ æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sub   = calcRecipeCost(subR, new Set(visited));
      const baseQty = subR.qtyPerCraft||1;
      // ã‚¹ã‚­ãƒ«æœŸå¾…å€¤: skill%ç¢ºç‡ã§+1å€‹ãªã®ã§æœŸå¾…å€¤ baseQty*(1+p)
      const perQty = baseQty * skillMultiplier(subR);

      // è‡ªå‹•è¨ˆç®—ã®å˜ä¾¡ (1å€‹ã‚ãŸã‚Šãƒ»ã‚¹ã‚­ãƒ«æœŸå¾…å€¤è¾¼ã¿)
      const autoRunoPer  = sub.runo!=null   ? sub.runo/perQty  : null;
      const autoBindPer  = sub.bindRuno/perQty;
      const autoFocusPer = (sub.focus + (subR.focus||0)) / perQty; // ã‚µãƒ–è‡ªèº«ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚‚å«ã‚€
      const autoTotalPer = autoRunoPer!=null ? autoRunoPer + autoBindPer : null;

      // å–å¼•æ‰€è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ï¼ˆUM ãƒ•ãƒ©ã‚° + ä¾¡æ ¼å…¥åŠ›æ¸ˆã¿ï¼‰
      const useMarket = UM[subR.id] && (U[subR.id] !== undefined && U[subR.id] !== null);
      const mktPrice  = useMarket ? U[subR.id] : 0;

      let src, lineRuno=null, lineBind=0, lineFocus=0;

      if(useMarket){
        // å–å¼•æ‰€è³¼å…¥ãƒ¢ãƒ¼ãƒ‰: ãƒ«ãƒ¼ãƒã§è³¼å…¥ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»ãªã—
        src='market'; lineRuno=mktPrice*m.qty; lineBind=0; lineFocus=0;
      } else if(autoTotalPer!=null){
        // è‡ªå‹•è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰
        src='auto';
        lineRuno  = autoRunoPer!=null ? autoRunoPer*m.qty : null;
        lineBind  = autoBindPer*m.qty;
        lineFocus = autoFocusPer*m.qty;
      } else {
        src='unknown'; hasUnk=true;
      }

      if(src!=='market' && lineRuno==null) hasUnk=true;
      else {
        if(lineRuno!=null) totalRuno += lineRuno;
        totalBind  += lineBind;
        totalFocus += lineFocus;
      }

      breakdown.push({name:m.name, qty:m.qty,
        runo:lineRuno, bindRuno:lineBind, focusUsed:lineFocus, src, isRecipe:true,
        autoRunoPer, autoBindPer, autoFocusPer, autoTotalPer,
        mktPrice, subBreakdown:sub.breakdown, subQtyPerCraft:perQty});

    } else if(subM){
      // â”€â”€ ç”Ÿç´ æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const price = userMatPrice(subM);
      if(price === null){ hasUnk=true; breakdown.push({name:m.name,qty:m.qty,runo:null,bindRuno:0,focusUsed:0,src:'unknown',npcPrice:subM.npcPrice,tag2:subM.tag2,npcShops:subM.npcShops||[]}); continue; }

      const isNpc = subM.npcPrice!=null;
      let lineRuno=0, lineBind=0;
      if(isNpc){ lineBind=price*m.qty; }
      else      { lineRuno=price*m.qty; }
      totalRuno += lineRuno; totalBind += lineBind;

      breakdown.push({name:m.name, qty:m.qty,
        runo:isNpc?0:lineRuno, bindRuno:isNpc?lineBind:0, focusUsed:0,
        src: isNpc?'npc':'raw', npcPrice:subM.npcPrice, tag2:subM.tag2, npcShops:subM.npcShops||[]});

    } else {
      hasUnk=true;
      breakdown.push({name:m.name,qty:m.qty,runo:null,bindRuno:0,focusUsed:0,src:'unknown'});
    }
  }

  return {
    runo:     hasUnk ? null : totalRuno,
    bindRuno: totalBind,
    focus:    totalFocus,
    hasUnk, breakdown
  };
}

function calcProfit(recipe){
  const sell     = sellPrice(recipe);
  const cost     = calcRecipeCost(recipe);
  const qty      = recipe.qtyPerCraft||1;
  const ownFocus = recipe.focus||0;
  const sellUnk  = sell === null;
  const matUnk   = cost.hasUnk;

  if(sellUnk || matUnk){
    return {profit:null,profitRuno:null,perItem:null,perFocus:null,
            sell, cost, matUnk, sellUnk, totalFocus:null};
  }

  // ã‚¹ã‚­ãƒ«æœŸå¾…å€¤å€ç‡
  const effQty     = qty * skillMultiplier(recipe);
  const revenue    = sell * effQty;
  const profitRuno = revenue - (cost.runo ?? 0);
  const profit     = revenue - (cost.runo ?? 0) - cost.bindRuno;
  const totalFocus = ownFocus + cost.focus;
  const perItem    = profit / effQty;
  const perFocus   = totalFocus>0 ? profit/totalFocus : null;

  return {profit, profitRuno, perItem, perFocus, sell, cost, matUnk:false, sellUnk:false, totalFocus, effQty};
}

function sellPrice(recipe){
  const v = U[recipe.id];
  return (v !== undefined && v !== null) ? v : null;
}

/* ===================== PAGE SWITCH ===================== */
function showPage(name,btn){
  document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='mat')  renderMatPage();
  if(name==='calc') renderCalcList();
  if(name==='rank') renderRanking();
  saveUI();
}

/* ===================== PAGE: ç´ æä¾¡æ ¼å…¥åŠ› ===================== */
let matFilter = 'ALL';

// Sidebar filter values: 'ALL' | 'ç´ æALL' | 'NPCè³¼å…¥å¯' | 'ä¸­é–“ç´ æ' | 'å®Œæˆå“'

function renderMatPage(){
  const nav = document.getElementById('mat-nav');
  nav.innerHTML='';

  const matTotal = D.materials.length;
  const npcCnt   = D.materials.filter(m=>m.tag2.includes('NPCè³¼å…¥å¯')).length;
  const intCnt   = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ').length;
  const finCnt   = D.recipes.filter(r=>r.tag1==='å®Œæˆå“').length;
  const allTotal = matTotal + intCnt + finCnt;

  const npcMatCnt  = D.materials.filter(m=>m.tag2.includes('NPCè³¼å…¥å¯')).length;
  const noNpcMatCnt= matTotal - npcMatCnt;
  const intNpcCnt  = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&(r.tag2||[]).includes('NPCè³¼å…¥å¯')).length;
  const intNoNpcCnt= intCnt - intNpcCnt;

  // æœªå…¥åŠ›ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä¾¡æ ¼å…¥åŠ›ã‚¿ãƒ–åŸºæº–: U[id]ãŒæœªè¨­å®šã®ã‚‚ã®ã ã‘ï¼‰
  const unkMatCount  = D.materials.filter(m=>U[m.id]===undefined||U[m.id]===null).length;
  const unkIntCount  = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&(U[r.id]===undefined||U[r.id]===null)).length;
  const unkFinCount  = D.recipes.filter(r=>r.tag1==='å®Œæˆå“'&&(U[r.id]===undefined||U[r.id]===null)).length;
  const unkTotal     = unkMatCount + unkIntCount + unkFinCount;

  const items = [
    { val:'ALL',         label:'ã™ã¹ã¦',                 cnt:allTotal },
    { val:'æœªå…¥åŠ›', label:'æœªå…¥åŠ›', cnt:unkTotal, hidden:(unkTotal===0) },
    { val:'ç´ æALL',     label:'ç´ æ',                   cnt:noNpcMatCnt },
    { val:'ç´ æNPC',     label:'ç´ æï¼ˆNPCè³¼å…¥å¯ï¼‰',      cnt:npcMatCnt },
    { val:'ä¸­é–“ç´ æ',    label:'ä¸­é–“ç´ æ',                cnt:intNoNpcCnt },
    { val:'ä¸­é–“NPC',     label:'ä¸­é–“ç´ æï¼ˆNPCè³¼å…¥å¯ï¼‰',  cnt:intNpcCnt },
    { val:'å®Œæˆå“',      label:'å®Œæˆå“',                 cnt:finCnt },
  ];

  // æœªå…¥åŠ›0ä»¶ãªã®ã«ãƒ•ã‚£ãƒ«ã‚¿ãŒæœªå…¥åŠ›ã®ã¾ã¾ãªã‚‰ALLã«æˆ»ã™
  if(unkTotal===0 && matFilter==='æœªå…¥åŠ›'){ matFilter='ALL'; saveUI(); }

  for(const it of items){
    const d = document.createElement('div');
    d.className='snav-item'+(matFilter===it.val?' active':'');
    d.style.paddingLeft = '12px';
    if(it.val==='æœªå…¥åŠ›'){ d.style.color='#b91c1c'; if(it.hidden) d.style.display='none'; }
    d.dataset.navVal = it.val;
    d.innerHTML = `${it.label}<span class="snav-cnt">${it.cnt}</span>`;
    d.onclick=()=>{
      matFilter=it.val;
      document.querySelectorAll('.snav-item').forEach(e=>e.classList.remove('active'));
      d.classList.add('active');
      renderMatBody();
      saveUI();
    };
    nav.appendChild(d);
  }
  renderMatBody();
}

function renderMatBody(){
  const titleMap = {
    'ALL':      'ã™ã¹ã¦',
    'æœªå…¥åŠ›':   'æœªå…¥åŠ›',
    'ç´ æALL':  'ç´ æ',
    'ç´ æNPC':  'ç´ æï¼ˆNPCè³¼å…¥å¯ï¼‰',
    'ä¸­é–“ç´ æ': 'ä¸­é–“ç´ æ',
    'ä¸­é–“NPC':  'ä¸­é–“ç´ æï¼ˆNPCè³¼å…¥å¯ï¼‰',
    'å®Œæˆå“':   'å®Œæˆå“',
  };
  document.getElementById('mat-title').textContent = titleMap[matFilter]||matFilter;

  const wrap = document.getElementById('mat-body');

  const showUnk     = matFilter==='æœªå…¥åŠ›';
  const showMats    = matFilter==='ALL' || matFilter==='ç´ æALL';
  const showNpcMats = matFilter==='ç´ æNPC';
  const showInt     = matFilter==='ALL' || matFilter==='ä¸­é–“ç´ æ';
  const showIntNpc  = matFilter==='ä¸­é–“NPC';
  const showFin     = matFilter==='ALL' || matFilter==='å®Œæˆå“';

  const isUnk = id => U[id]===undefined || U[id]===null;

  // ç´ æ: æœªå…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿/NPCè³¼å…¥å¯ãƒ•ã‚£ãƒ«ã‚¿/é€šå¸¸
  let mats = showUnk     ? D.materials.filter(m=>isUnk(m.id))
           : matFilter==='ALL'  ? D.materials
           : showMats    ? D.materials.filter(m=>!m.tag2.includes('NPCè³¼å…¥å¯'))
           : showNpcMats ? D.materials.filter(m=>m.tag2.includes('NPCè³¼å…¥å¯'))
           : [];
  // â”€â”€ ç´ æãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€
  let rows='';
  for(const m of mats){
    const v = U[m.id] ?? '';
    const filled = v !== '';
    const isNpc = m.npcPrice!=null;
    const tags2html = m.tag2.map(t=>`<span class="tag tag-${t}">${t}</span>`).join('');
    const shopsHtml = (m.npcShops||[]).length
      ? `<div style="font-size:10px;color:var(--npc);margin-top:3px">${m.npcShops.join(' Â· ')}</div>` : '';
    const matUnk = isUnk(m.id);
    rows+=`<tr id="mat-row-${m.id}">
      <td>
        <div class="mat-name">${m.name}</div>
        <div class="mat-tags">
          ${tags2html}
          ${matUnk?'<span class="tag tag-æœªå…¥åŠ›">æœªå…¥åŠ›</span>':''}
        </div>
        ${shopsHtml}
      </td>
      <td class="col-r">
        <div class="price-wrap">
          ${isNpc ? `<span class="npc-ref">NPC: ${fmt(m.npcPrice)} ãƒã‚¤ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ</span>` : ''}
          <input type="number" min="0"
            class="price-inp${filled?' filled':''}"
            placeholder="æœªå…¥åŠ›" value="${v}"
            oninput="setMatPrice('${m.id}',this)">
          <span class="unit">ãƒ«ãƒ¼ãƒ</span>
        </div>
      </td>
    </tr>`;
  }

  // â”€â”€ ä¸­é–“ç´ æãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€
  const intRecipes = showUnk    ? D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&isUnk(r.id))
                  : showInt    ? D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&!(r.tag2||[]).includes('NPCè³¼å…¥å¯'))
                  : showIntNpc  ? D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&(r.tag2||[]).includes('NPCè³¼å…¥å¯'))
                  : [];
  let intRows='';
  for(const r of intRecipes){
    const auto = calcRecipeCost(r);
    const autoCostPer = !auto.hasUnk ? (auto.runo+auto.bindRuno)/(r.qtyPerCraft||1) : null;
    const autoStr = autoCostPer!=null ? `è‡ªå‹•è¨ˆç®—: ${fmt(autoCostPer)} ãƒ«ãƒ¼ãƒ/å€‹` : 'è‡ªå‹•è¨ˆç®—: ç´ ææœªå…¥åŠ›';
    const isMarket = !!UM[r.id];
    const v = U[r.id] ?? '';
    const filled = v !== '';
    intRows+=`<tr id="mat-row-${r.id}">
      <td>
        <div class="mat-name">${r.name}</div>
        <div class="mat-tags">
          <span class="tag tag-ä¸­é–“ç´ æ">ä¸­é–“ç´ æ</span>
          <span class="tag" style="background:var(--g-l);color:var(--g)">${autoStr}</span>
          ${isUnk(r.id)?'<span class="tag tag-æœªå…¥åŠ›">æœªå…¥åŠ›</span>':''}
        </div>
      </td>
      <td class="col-r">
        <div class="price-wrap">
          <input type="number" min="0"
            class="price-inp${filled?' filled':''}"
            placeholder="å–å¼•æ‰€ä¾¡æ ¼ï¼ˆ1å€‹ï¼‰" value="${v}"
            oninput="setRecipeMarketPrice('${r.id}',this)">
          <span class="unit">ãƒ«ãƒ¼ãƒ</span>
        </div>
        <label class="mkt-toggle" style="margin-top:5px;justify-content:flex-end">
          <input type="checkbox" ${isMarket?'checked':''} onchange="setIntMode('${r.id}',this.checked)">
          <span class="mkt-toggle-label">${isMarket?'å–å¼•æ‰€è³¼å…¥ã§è¨ˆç®—ä¸­':'å–å¼•æ‰€è³¼å…¥ã§è¨ˆç®—ã™ã‚‹'}</span>
        </label>
      </td>
    </tr>`;
  }

  // â”€â”€ å®Œæˆå“ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€
  const finRecipes = (showFin||showUnk) ? D.recipes.filter(r=>r.tag1==='å®Œæˆå“'&&(showFin||isUnk(r.id))) : [];
  let finRows='';
  for(const r of finRecipes){
    const v = U[r.id] ?? '';
    const filled = v !== '';
    finRows+=`<tr id="mat-row-${r.id}">
      <td>
        <div class="mat-name">${r.name}</div>
        <div class="mat-tags">
          <span class="tag tag-å®Œæˆå“">å®Œæˆå“</span>
          <span class="cat-badge cat-${r.category}">${r.category}</span>
          ${isUnk(r.id)?'<span class="tag tag-æœªå…¥åŠ›">æœªå…¥åŠ›</span>':''}
        </div>
      </td>
      <td class="col-r">
        <div class="price-wrap">
          <input type="number" min="0"
            class="price-inp${filled?' filled':''}"
            placeholder="è²©å£²ä¾¡æ ¼ï¼ˆ1å€‹ï¼‰" value="${v}"
            oninput="setRecipeMarketPrice('${r.id}',this)">
          <span class="unit">ãƒ«ãƒ¼ãƒ / å€‹</span>
        </div>
      </td>
    </tr>`;
  }

  if(!rows&&!intRows&&!finRows){
    wrap.innerHTML='<div style="padding:40px;text-align:center;color:var(--t3)">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  wrap.innerHTML = `
    ${rows ? `<div class="mat-tbl-wrap">
      <table class="mat-tbl">
        <thead><tr><th>ç´ æå / ã‚¿ã‚°</th><th style="text-align:right">ä¾¡æ ¼ (ãƒ«ãƒ¼ãƒ/å€‹)</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>` : ''}
    ${intRows ? `
    <div style="margin-top:20px;margin-bottom:8px;display:flex;align-items:center;gap:10px">
      <span style="font-size:12px;font-weight:700;color:var(--t2)">ä¸­é–“ç´ æ</span>
      <button class="btn btn-ghost" style="font-size:11px;padding:2px 10px;height:auto" onclick="setAllIntMode(true)">ã™ã¹ã¦å–å¼•æ‰€è³¼å…¥</button>
      <button class="btn btn-ghost" style="font-size:11px;padding:2px 10px;height:auto" onclick="setAllIntMode(false)">ã™ã¹ã¦è‡ªå‹•è¨ˆç®—</button>
    </div>
    <div class="mat-tbl-wrap">
      <table class="mat-tbl">
        <thead><tr><th>ä¸­é–“ç´ æå / è‡ªå‹•è¨ˆç®—ã‚³ã‚¹ãƒˆ</th><th style="text-align:right">å–å¼•æ‰€è³¼å…¥ / ä¾¡æ ¼</th></tr></thead>
        <tbody>${intRows}</tbody>
      </table>
    </div>` : ''}
    ${finRows ? `
    <div style="margin-top:20px;font-size:12px;font-weight:700;color:var(--t2);margin-bottom:8px">å®Œæˆå“ã®è²©å£²ä¾¡æ ¼</div>
    <div class="mat-tbl-wrap">
      <table class="mat-tbl">
        <thead><tr><th>å®Œæˆå“å</th><th style="text-align:right">è²©å£²ä¾¡æ ¼ï¼ˆãƒ«ãƒ¼ãƒ/å€‹ï¼‰</th></tr></thead>
        <tbody>${finRows}</tbody>
      </table>
    </div>` : ''}
  `;
}

function setMatPrice(id, el){
  const v = parseFloat(el.value);
  if(!isNaN(v)&&v>=0){ U[id]=v; el.classList.add('filled'); }
  else { delete U[id]; el.classList.remove('filled'); }
  saveUser(); refreshChips(); saveUI();
  refreshMatNavCounts();
}

function setRecipeMarketPrice(id, el){
  const v = parseFloat(el.value);
  if(!isNaN(v)&&v>=0){ U[id]=v; el.classList.add('filled'); }
  else { delete U[id]; el.classList.remove('filled'); }
  saveUser(); refreshChips(); saveUI();
  refreshMatNavCounts();
}

// ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚«ã‚¦ãƒ³ãƒˆãƒãƒƒã‚¸ã ã‘å†è¨ˆç®—ï¼ˆå…¥åŠ›ä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
function refreshMatNavCounts(){
  const matTotal  = D.materials.length;
  const npcMatCnt = D.materials.filter(m=>m.tag2.includes('NPCè³¼å…¥å¯')).length;
  const intCnt    = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ').length;
  const intNpcCnt = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&(r.tag2||[]).includes('NPCè³¼å…¥å¯')).length;
  const finCnt    = D.recipes.filter(r=>r.tag1==='å®Œæˆå“').length;
  const isUnk     = id => U[id]===undefined || U[id]===null;
  const unkMatCount = D.materials.filter(m=>isUnk(m.id)).length;
  const unkIntCount = D.recipes.filter(r=>r.tag1==='ä¸­é–“ç´ æ'&&isUnk(r.id)).length;
  const unkFinCount = D.recipes.filter(r=>r.tag1==='å®Œæˆå“'&&isUnk(r.id)).length;
  const unkTotal    = unkMatCount + unkIntCount + unkFinCount;

  const counts = {
    'ALL':      matTotal + intCnt + finCnt,
    'æœªå…¥åŠ›':   unkTotal,
    'ç´ æALL':  matTotal - npcMatCnt,
    'ç´ æNPC':  npcMatCnt,
    'ä¸­é–“ç´ æ': intCnt - intNpcCnt,
    'ä¸­é–“NPC':  intNpcCnt,
    'å®Œæˆå“':   finCnt,
  };
  document.querySelectorAll('#mat-nav .snav-item').forEach(el=>{
    const val = el.dataset.navVal;
    const cnt = el.querySelector('.snav-cnt');
    if(!val || !cnt) return;
    if(val==='æœªå…¥åŠ›'){
      el.style.display = unkTotal===0 ? 'none' : '';
      cnt.textContent = unkTotal;
      if(unkTotal===0 && matFilter==='æœªå…¥åŠ›'){
        matFilter='ALL';
        saveUI();
        // ãƒ•ã‚£ãƒ«ã‚¿ãŒæœªå…¥åŠ›ã§0ä»¶ã«ãªã£ãŸã‚‰å†æç”»
        renderMatBody();
      }
    } else if(counts[val]!==undefined){
      cnt.textContent = counts[val];
    }
  });
  // æœªå…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ä¸­ã¯æœ¬ä½“ã‚‚å†æç”»ï¼ˆè¡Œã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åæ˜ ï¼‰
  if(matFilter==='æœªå…¥åŠ›') renderMatBody();
}

// æœªå…¥åŠ›ç´ æã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ (ä¾¡æ ¼å…¥åŠ›ã‚¿ãƒ–ã«åæ˜ )

// ç´ æä¾¡æ ¼å…¥åŠ›ã‚¿ãƒ–ã®è©²å½“è¡Œã«ã‚¸ãƒ£ãƒ³ãƒ—
function jumpToMat(id){
  // ã¾ãšã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
  const matBtn = document.querySelector('.nav-btn[onclick*="mat"]');
  if(matBtn) showPage('mat', matBtn);
  // ãƒ•ã‚£ãƒ«ã‚¿ã‚’ALLã«æˆ»ã—ã¦ã‹ã‚‰è©²å½“è¡Œã¸
  matFilter='ALL';
  renderMatPage();
  requestAnimationFrame(()=>{
    const row = document.getElementById('mat-row-'+id);
    if(row){
      row.scrollIntoView({behavior:'smooth', block:'center'});
      row.classList.add('jump-highlight');
      setTimeout(()=>row.classList.remove('jump-highlight'), 1400);
      const inp = row.querySelector('input');
      if(inp) setTimeout(()=>inp.focus(), 400);
    }
  });
}

/* ===================== PAGE: è¨ˆç®— ===================== */
let selId=null, catF='ALL', searchQ='', unkF=false;

function renderCalcList(){
  const bar=document.getElementById('cat-bar');
  bar.innerHTML='';
  const cats=['ALL',...new Set(D.recipes.map(r=>r.category))];
  for(const cat of cats){
    const b=document.createElement('button');
    b.className='fbtn'+(catF===cat?' active':'');
    b.textContent=cat==='ALL'?'ã™ã¹ã¦':cat;
    b.onclick=()=>{ catF=cat; document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderCalcItems(); saveUI(); };
    bar.appendChild(b);
  }
  // æœªå…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ï¼ˆæœªå…¥åŠ›ãŒ1ä»¶ä»¥ä¸Šã‚ã‚‹ã¨ãã®ã¿è¡¨ç¤ºï¼‰
  const hasAnyUnk = D.recipes.some(r=>recipeHasUnk(r));
  if(hasAnyUnk){
    const unkBtn=document.createElement('button');
    unkBtn.id='unk-fbtn';
    unkBtn.className='fbtn'+(unkF?' active':'');
    unkBtn.style.cssText=unkF
      ?'margin-left:8px;background:#b91c1c;border-color:#b91c1c;color:#fff'
      :'margin-left:8px;border-color:#fca5a5;color:#b91c1c';
    unkBtn.textContent='æœªå…¥åŠ›ã‚ã‚Š';
    unkBtn.onclick=()=>{
      unkF=!unkF;
      unkBtn.className='fbtn'+(unkF?' active':'');
      unkBtn.style.cssText=unkF
        ?'margin-left:8px;background:#b91c1c;border-color:#b91c1c;color:#fff'
        :'margin-left:8px;border-color:#fca5a5;color:#b91c1c';
      renderCalcItems(); saveUI();
    };
    bar.appendChild(unkBtn);
  } else if(unkF){
    // æœªå…¥åŠ›0ä»¶ãªã®ã«unkFãŒONãªã‚‰è§£é™¤
    unkF=false; saveUI();
  }
  renderCalcItems();
}

function onSearch(q){ searchQ=q; renderCalcItems(); }

function recipeHasUnk(r){
  // è²»ç”¨è¨ˆç®—ã‚¿ãƒ–åŸºæº–: ç´ ææœªå…¥åŠ› OR å£²å€¤æœªè¨­å®š ã®ã©ã¡ã‚‰ã‹ã§ã‚‚æœªå…¥åŠ›
  const p = calcProfit(r);
  return p.matUnk || p.sellUnk;
}

function renderCalcItems(){
  let items=D.recipes;
  if(catF!=='ALL') items=items.filter(r=>r.category===catF);
  if(searchQ){ const q=searchQ.toLowerCase(); items=items.filter(r=>r.name.toLowerCase().includes(q)); }
  if(unkF) items=items.filter(r=>recipeHasUnk(r));

  const list=document.getElementById('item-list');
  list.innerHTML='';
  for(const r of items){
    const p=calcProfit(r);
    const hasUnk=recipeHasUnk(r);
    const row=document.createElement('div');
    row.className='item-row'+(selId===r.id?' sel':'');
    row.dataset.id=r.id;
    row.onclick=()=>selectItem(r.id);

    let chip;
    if(p.profit!=null){
      chip=`<span class="chip ${p.profit>0?'chip-p':p.profit<0?'chip-l':'chip-z'}">${p.profit>=0?'+':''}${fmt(p.profit)}</span>`;
    } else {
      chip=`<span class="chip chip-z">â€”</span>`;
    }
    row.innerHTML=`
      <div class="dot" style="background:${catColor(r.category)}"></div>
      <div>
        <div class="row-name">${r.name}</div>
        <div class="row-sub">
          <span class="tag tag-${r.tag1}">${r.tag1}</span>
          ${hasUnk?'<span class="tag tag-æœªå…¥åŠ›">æœªå…¥åŠ›</span>':''}
        </div>
      </div>
      ${chip}`;
    list.appendChild(row);
  }
}

function refreshChips(){
  document.querySelectorAll('.item-row').forEach(row=>{
    const r=D.recipes.find(x=>x.id===row.dataset.id); if(!r) return;
    const p=calcProfit(r);
    const chip=row.querySelector('.chip'); if(!chip) return;
    if(p.profitRuno!=null){
      chip.className=`chip ${p.profitRuno>0?'chip-p':p.profitRuno<0?'chip-l':'chip-z'}`;
      chip.textContent=`${p.profitRuno>=0?'+':''}${fmt(p.profitRuno)}`;
    } else { chip.className='chip chip-z'; chip.textContent='â€”'; }
    // æœªå…¥åŠ›ã‚¿ã‚°æ›´æ–°
    const sub=row.querySelector('.row-sub');
    if(sub){
      const hasUnk=recipeHasUnk(r);
      const existing=sub.querySelector('.tag-æœªå…¥åŠ›');
      if(hasUnk && !existing) sub.insertAdjacentHTML('beforeend','<span class="tag tag-æœªå…¥åŠ›">æœªå…¥åŠ›</span>');
      else if(!hasUnk && existing) existing.remove();
    }
  });
  if(selId) renderDetail();
  // è²»ç”¨è¨ˆç®—ã‚¿ãƒ–ãŒè¡¨ç¤ºä¸­ãªã‚‰æœªå…¥åŠ›ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚‚æ›´æ–°
  if(document.getElementById('page-calc').classList.contains('active')){
    const hasAnyUnk = D.recipes.some(r=>recipeHasUnk(r));
    const unkBtn = document.getElementById('unk-fbtn');
    if(!hasAnyUnk && unkBtn){ unkBtn.remove(); if(unkF){ unkF=false; saveUI(); renderCalcItems(); } }
    else if(hasAnyUnk && !unkBtn) renderCalcList(); // ãƒœã‚¿ãƒ³ãŒæ¶ˆãˆã¦ã„ãŸã‚‰å†ç”Ÿæˆ
  }
}

function selectItem(id){
  selId=id;
  document.querySelectorAll('.item-row').forEach(r=>r.classList.toggle('sel',r.dataset.id===id));
  renderDetail();
  saveUI();
}

function renderDetail(){
  const panel=document.getElementById('detail');
  if(!selId){ panel.innerHTML=`<div class="empty-state"><p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>`; return; }
  const recipe=D.recipes.find(r=>r.id===selId); if(!recipe) return;

  const p       = calcProfit(recipe);
  const qty     = recipe.qtyPerCraft||1;
  const effQty  = p.effQty || qty;
  const ownFocus= recipe.focus||0;
  const cost    = p.cost;

  // â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¡ã‚¿ â”€â”€
  const tag2html = recipe.tag2.map(t=>`<span class="tag tag-${t}">${t}</span>`).join('');

  // â”€â”€ ã‚¹ã‚¿ãƒƒãƒˆã‚«ãƒ¼ãƒ‰å€¤ â”€â”€
  const runoStr      = cost.runo!=null     ? fmt(cost.runo)     : '?';
  const bindStr      = cost.bindRuno>0     ? fmt(cost.bindRuno) : 'â€”';

  // â”€â”€ å†…è¨³ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œ â”€â”€
  function currTag(runo, bind){
    const parts=[];
    if(bind>0) parts.push(`<span class="cur-bind">${fmt(bind)}</span>`);
    if(runo!=null && runo>=0) parts.push(`<span class="cur-runo">${fmt(runo)}</span>`);
    if(!parts.length) return '<span style="color:var(--t4)">0</span>';
    return parts.join(' + ');
  }

  let bdRows='';
  for(const b of cost.breakdown){
    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¸ãƒ£ãƒ³ãƒ—å…ˆIDå–å¾—
    const jumpId = b.isRecipe
      ? D.recipes.find(r=>r.name===b.name)?.id
      : D.materials.find(m=>m.name===b.name)?.id;
    const clickAttr = jumpId ? `onclick="jumpToMat('${jumpId}')" title="ç´ æä¾¡æ ¼å…¥åŠ›ã§ç·¨é›†"` : '';
    const nameClass = jumpId ? 'mat-clickable' : '';

    if(b.isRecipe){
      let srcBadge='';
      if(b.src==='auto')      srcBadge=`<span class="src-auto">è‡ªå‹•è¨ˆç®—</span>`;
      else if(b.src==='market') srcBadge=`<span class="src-mkt">å–å¼•æ‰€è³¼å…¥</span>`;
      else if(b.src==='unknown') srcBadge=`<span class="unk">ä¸æ˜</span>`;

      let cmpNote='';
      if(b.src==='market'){
        cmpNote=`<div class="tr-sub" style="padding-left:0;color:var(--t3)">
          å–å¼•æ‰€è³¼å…¥: <span class="cur-runo">${fmt(b.mktPrice)}</span>/å€‹ â†’ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»ãªã—
          ${b.autoTotalPer!=null ? `ï¼ˆè‡ªå‹•è¨ˆç®—ã‚³ã‚¹ãƒˆ: <span class="cur-runo">${fmt(b.autoRunoPer??0)}</span>${b.autoBindPer>0?` + <span class="cur-bind">${fmt(b.autoBindPer)}</span>`:''}/å€‹ ï¼‹ <span class="cur-focus">${fmtQ(b.autoFocusPer)}F</span>ï¼‰` : ''}
        </div>`;
      } else if(b.src==='auto'){
        cmpNote=`<div class="tr-sub" style="padding-left:0;color:var(--t3)">
          è‡ªå‹•è¨ˆç®—: <span class="cur-runo">${fmt(b.autoRunoPer??0)}</span>${b.autoBindPer>0?` + <span class="cur-bind">${fmt(b.autoBindPer)}</span>`:''}/å€‹ ï¼‹ <span class="cur-focus">${fmtQ(b.autoFocusPer)}F</span>
        </div>`;
      }

      const focusCell = b.focusUsed>0 ? ` <span class="cur-focus">${fmtQ(b.focusUsed)}</span>` : '';

      bdRows+=`<tr>
        <td>
          <div class="tr-main"><span class="${nameClass}" ${clickAttr}>${b.name}</span> <span style="color:var(--t3)">Ã— ${b.qty}</span> <span class="tag tag-ä¸­é–“ç´ æ">ä¸­é–“ç´ æ</span> ${srcBadge}</div>
          ${cmpNote}
        </td>
        <td>${b.runo!=null||b.bindRuno>0 ? currTag(b.runo??0,b.bindRuno)+focusCell : '<span class="unk">?</span>'}</td>
      </tr>`;
    } else {
      const tagsHtml=(b.tag2||[]).map(t=>`<span class="tag tag-${t}">${t}</span>`).join('');
      const isNpc = b.src==='npc';
      const costCell = isNpc
        ? `<span class="cur-bind">${b.bindRuno!=null?fmt(b.bindRuno):'?'}</span>`
        : b.runo!=null ? `<span class="cur-runo">${fmt(b.runo)}</span>` : '<span class="unk">ä¾¡æ ¼æœªå…¥åŠ› â€” ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥åŠ›</span>';
      const shopHtml = (b.npcShops||[]).length
        ? `<div style="font-size:10px;color:var(--npc);margin-top:2px">${b.npcShops.join(' / ')}</div>` : '';

      bdRows+=`<tr>
        <td>
          <div class="tr-main"><span class="${nameClass}" ${clickAttr}>${b.name}</span> <span style="color:var(--t3)">Ã— ${b.qty}</span> ${tagsHtml}</div>
          ${shopHtml}
        </td>
        <td>${costCell}</td>
      </tr>`;
    }
  }

  // â”€â”€ åˆ©ç›Šè¡¨ç¤º â”€â”€
  const profitRunoCls = p.profitRuno!=null ? (p.profitRuno>0?'v-profit':p.profitRuno<0?'v-loss':'') : '';
  const profitRunoDisp = p.profitRuno!=null ? (p.profitRuno>=0?'+':'')+fmt(p.profitRuno)+' ãƒ«ãƒ¼ãƒ' : '?';
  const bindCostDisp   = cost.bindRuno>0 ? 'âˆ’'+fmt(cost.bindRuno)+' ãƒã‚¤ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ' : null;
  const perFocusDisp   = p.perFocus!=null ? (p.perFocus>=0?'+':'')+fmt(p.perFocus)+' / ãƒ•ã‚©ãƒ¼ã‚«ã‚¹' : (p.totalFocus?'?':'â€”');
  const perFocusCls    = p.perFocus!=null ? (p.perFocus>0?'v-profit':p.perFocus<0?'v-loss':'') : '';


  panel.innerHTML=`<div style="max-width:720px">
    <div class="det-header">
      <div class="det-icon">${catEmoji(recipe.category)}</div>
      <div>
        <div class="det-name">${recipe.name}</div>
        <div class="det-meta">
          <span class="cat-badge cat-${recipe.category}">${recipe.category}</span>
          <span class="tag tag-${recipe.tag1}">${recipe.tag1}</span>
          ${tag2html}
          <span style="font-size:11px;color:var(--t3)">1ã‚¯ãƒ©ãƒ•ãƒˆ â†’ ${qty}å€‹ / ${ownFocus}ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¶ˆè²»</span>
          ${recipe.skill ? `<span style="font-size:11px;color:var(--profit);font-weight:700">${recipe.skill}% ã§2å€‹ï¼ˆã‚¹ã‚­ãƒ«ï¼‰</span>` : ''}
          ${recipe.skill && masteryMode ? `<span style="font-size:11px;color:var(--t3)">ï¼ˆæœŸå¾…å€¤ Ã—${(1+recipe.skill/100).toFixed(3)}ï¼‰</span>` : ''}
          ${recipe.note?`<span style="font-size:11px;color:var(--t3)">${recipe.note}</span>`:''}
        </div>
      </div>
    </div>

    ${p.matUnk?`<div class="warn-box">ä¾¡æ ¼ãŒæœªå…¥åŠ›ã®ç´ æãŒã‚ã‚Šã¾ã™ã€‚å†…è¨³ã®ç´ æåã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>`:''}
    ${p.sellUnk?`<div class="warn-box" style="background:#e8f4ff;border-color:#a8d4ff;color:#1a5f9e">è²©å£²ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™ã€‚ã€Œä¾¡æ ¼å…¥åŠ›ã€ã‚¿ãƒ–ã®å®Œæˆå“æ¬„ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>`:''}


    <div class="stat-row">
      <div class="stat-card">
        <div class="stat-lbl">ç´ æã‚³ã‚¹ãƒˆ <span class="cur-runo">ãƒ«ãƒ¼ãƒ</span></div>
        <div class="stat-val v-warn" style="font-size:17px">${cost.runo!=null?fmt(cost.runo):'?'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">ç´ æã‚³ã‚¹ãƒˆ <span class="cur-bind">ãƒã‚¤ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ</span></div>
        <div class="stat-val" style="font-size:17px;color:var(--npc)">${cost.bindRuno>0?fmt(cost.bindRuno):'â€”'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">æ¶ˆè²»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆè¨ˆ</div>
        <div class="stat-val" style="font-size:15px;color:var(--focus)">${p.totalFocus>0?fmtQ(p.totalFocus)+(ownFocus>0?` (è‡ª${ownFocus} + ç´ æ${fmtQ(cost.focus)})`:` (ç´ æã®ã¿)`):(ownFocus>0?String(ownFocus):'â€”')}</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">å£²ä¸Š (Ã— ${fmtQ(effQty)}å€‹)</div>
        <div class="stat-val v-accent" style="font-size:17px">${p.sell!=null?fmt(p.sell*effQty):'?'}</div>
      </div>
    </div>

    <div class="stat-row" style="grid-template-columns:1fr 1fr;margin-top:0">
      <div class="stat-card hi" style="padding:18px 20px">
        <div class="stat-lbl">åˆ©ç›Š</div>
        <div class="stat-val ${profitRunoCls}" style="font-size:22px;margin-bottom:6px">${profitRunoDisp}</div>
        ${bindCostDisp ? `<div style="font-size:14px;font-weight:700;color:var(--npc)">${bindCostDisp}</div>` : ''}
      </div>
      <div class="stat-card" style="padding:18px 20px">
        <div class="stat-lbl">1ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚ãŸã‚Šåˆ©ç›Š${p.totalFocus?` (Ã· ${fmtQ(p.totalFocus)})`:''}</div>
        <div class="stat-val ${perFocusCls}" style="font-size:20px">${perFocusDisp}</div>
      </div>
    </div>

    <div class="sec-title">ç´ æã‚³ã‚¹ãƒˆå†…è¨³
      <span style="font-size:10px;font-weight:400;letter-spacing:0;color:var(--t3)">
        <span class="cur-runo"></span>=ãƒ«ãƒ¼ãƒï¼ˆå–å¼•æ‰€ï¼‰
        <span class="cur-bind" style="margin-left:6px"></span>=ãƒã‚¤ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒï¼ˆNPCï¼‰
        <span class="cur-focus" style="margin-left:6px"></span>=ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      </span>
    </div>
    <table class="bd-tbl">
      <thead><tr><th>ç´ æ</th><th style="min-width:160px">ã‚³ã‚¹ãƒˆ</th></tr></thead>
      <tbody>${bdRows}</tbody>
      <tfoot>
        <tr style="background:var(--bg)">
          <td style="font-weight:700;font-size:12px">åˆè¨ˆ</td>
          <td style="text-align:right;font-weight:700">
            ${cost.runo!=null?`<span class="cur-runo">${fmt(cost.runo)}</span> `:''}
            ${cost.bindRuno>0?`<span class="cur-bind">${fmt(cost.bindRuno)}</span> `:''}
            ${cost.focus>0?`<span class="cur-focus">${fmtQ(cost.focus)}</span>`:''}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>`;
}

/* ===================== PAGE: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===================== */
function jumpToCalc(recipeId){
  // è¨ˆç®—ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
  const calcBtn = document.querySelector('.nav-btn[onclick*="calc"]');
  if(calcBtn) showPage('calc', calcBtn);
  selId = recipeId;
  requestAnimationFrame(()=>{
    renderCalcItems();
    renderDetail();
    const row = document.querySelector(`.item-row[data-id="${recipeId}"]`);
    if(row){
      row.scrollIntoView({behavior:'smooth', block:'center'});
      row.classList.add('jump-highlight');
      setTimeout(()=>row.classList.remove('jump-highlight'), 1400);
    }
  });
}

function renderRanking(){
  const body=document.getElementById('rank-body');
  const ranked=D.recipes
    .filter(r=>r.tag1==='å®Œæˆå“' || r.tag1==='ä¸­é–“ç´ æ')
    .map(r=>({r,p:calcProfit(r)}))
    .filter(x=>x.p.profitRuno!=null)
    .sort((a,b)=>b.p.profitRuno-a.p.profitRuno);

  if(!ranked.length){
    body.innerHTML=`<div style="padding:60px;text-align:center;color:var(--t3);background:var(--white);border:1px solid var(--border);border-radius:var(--r)">
      <p>è²©å£²ä¾¡æ ¼ã¨ç´ æä¾¡æ ¼ã‚’ã€Œä¾¡æ ¼å…¥åŠ›ã€ã‚¿ãƒ–ã§å…¥åŠ›ã™ã‚‹ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>`;
    return;
  }
  const medals=['1','2','3'];
  const masteryNote = masteryMode ? '<span style="font-size:10px;color:var(--profit);margin-left:6px">ãƒã‚¹ã‚¿ãƒªãƒ¼ ONï¼ˆæœŸå¾…å€¤ï¼‰</span>' : '<span style="font-size:10px;color:var(--t3);margin-left:6px">ãƒã‚¹ã‚¿ãƒªãƒ¼ OFF</span>';
  body.innerHTML=`
    <div style="font-size:12px;color:var(--t3);margin-bottom:12px">åˆ©ç›Šãƒ©ãƒ³ã‚­ãƒ³ã‚° ${masteryNote} â€” ã‚¢ã‚¤ãƒ†ãƒ åã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã«ç§»å‹•</div>
    <table class="rank-tbl">
    <thead><tr>
      <th>é †ä½</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ã‚¢ã‚¤ãƒ†ãƒ å</th>
      <th>åˆ©ç›Š <span class="cur-runo">ãƒ«ãƒ¼ãƒ</span></th>
      <th>BRNæ¶ˆè²» <span class="cur-bind">ãƒã‚¤ãƒ³ãƒ‰</span></th>
      <th>æ¶ˆè²»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</th>
      <th>1ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚ãŸã‚Š</th>
    </tr></thead>
    <tbody>${ranked.map(({r,p},i)=>{
      const col=p.profitRuno>0?'var(--profit)':p.profitRuno<0?'var(--loss)':'var(--t2)';
      const sign=v=>v>=0?'+':'';
      const focusStr=p.totalFocus>0?fmtQ(p.totalFocus):'â€”';
      const pfStr=p.perFocus!=null?`${sign(p.perFocus)}${fmt(p.perFocus)}`:'â€”';
      const pfCol=p.perFocus!=null?(p.perFocus>0?'var(--profit)':p.perFocus<0?'var(--loss)':'var(--t2)'):'var(--t3)';
      const skillTag=r.skill?`<span style="font-size:9px;color:var(--profit)">${r.skill}%</span>`:'';
      return `<tr>
        <td class="rank-no">${medals[i]||(i+1)}</td>
        <td><span class="cat-badge cat-${r.category}">${r.category}</span></td>
        <td style="font-weight:600"><span class="rank-name-link" onclick="jumpToCalc('${r.id}')">${r.name}</span> ${skillTag}</td>
        <td style="color:${col};font-weight:700">${sign(p.profitRuno)}${fmt(p.profitRuno)}</td>
        <td style="color:var(--npc)">${p.cost.bindRuno>0?'âˆ’'+fmt(p.cost.bindRuno):'â€”'}</td>
        <td style="color:var(--focus)">${focusStr}</td>
        <td style="color:${pfCol}">${pfStr}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

/* ===================== NOTIFY ===================== */
function notif(msg){
  const el=document.getElementById('notif');
  el.textContent=msg; el.classList.add('show');
  clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'),3000);
}

init();
</script>
</body>
</html>
